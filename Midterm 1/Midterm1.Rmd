---
title: "Midterm One"
author: "Fran M"
date: "February 2, 2022"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
```
In this midterm we will analyze some data on the conservation status of species in North America and spending under the Endangered Species Act. 

**First read in the file conservationdata.csv**
This has data on over 53,000 North American species - a unique ID number (speciesid), scientific name (species name), taxonomic grouping (i.e. what type of species it is, taxon), the conservation status of that species in North America, as estimated by the organization [NatureServe](https://www.natureserve.org/conservation-tools/conservation-rank-calculator) (conservation_status), and whether the species is listed as threated or endangered under the US Endangered Species Act (listed, a value of 1 indicates the species is listed, a value of 0 indicates it is not).

```{r, message=FALSE, warning=FALSE}
conservationdata<-data.frame(read.csv("C:\\Users\\lukesau\\Desktop\\esp106-erin_rodriguez\\Midterm 1\\conservationdata.csv"))
```
The conservation status values can be interpreted as follows:

1 - Critically Imperiled
2 - Imperiled
3 - Vulnerable
4 - Apparently Secure
5 - Secture
UNK - Unknown
Prob. Extinct - Probably Extinct
Extinct - Extinct

Answer the following questions, showing your "working" in the chunks of R code. Upload the R markdown file and knitted output to Canvas. 

Make sure to add informative axis titles and, where appropriate, units to your answers.

1. What fraction of species in the dataset are listed under the Endangered Species Act? (2 points)
```{r, message=FALSE, warning=FALSE}
percentendangered<-round(((sum(conservationdata$listed)/nrow(conservationdata))*100), 2)
print(paste0(percentendangered, "% of species in the dataset are listed under the Endangered Species Act"))
```
2. Make a table (i.e. data frame) giving the breakdown of species by taxonomic group (i.e. one column is the taxonomic group and the second column is what fraction of the dataset that group represents) (4 points)

*Hint: Remember the query taxoncolumn==specific_taxon gives a vector of TRUE and FALSE corresponding to each row in the column. You can sum this up to get the total number in that taxon.* 

You can use a for loop for this, but it is not required. 
```{r, message=FALSE, warning=FALSE}
percentcolumn<-c()
taxons<-unique(conservationdata$taxon)
df2<-data.frame(Taxons=taxons)
for(i in 1:nrow(df2)){
  amount<-sum(conservationdata$taxon == df2[i, "Taxons"])
  percent<-round(((amount/nrow(conservationdata))*100), 2)
  percentcolumn<-append(percentcolumn, percent)
}
df2<-cbind(df2, Percent=percentcolumn)

```

3. a) One interesting question is how the conservation status varies between different taxonomic groups. Make a plot showing the distribution of conservation status within each taxonomic group (3 points)

*Hint: stat="count" (counts up and plots the number of observations, i.e. species, within each group) and position="fill" might both be useful here.* 
```{r, message=FALSE, warning=FALSE}
require(ggplot2)
ggplot(conservationdata, aes(fill=conservation_status, x=taxon))+
  geom_bar(Position="fill",stat= "count")+
  ggtitle("Conservation Status Within Each Taxonomic Group")
```

b) Based on this graph, what is something we might be concerned about in terms of analyzing the data on conservation status, particularly for fungi and invertebrates? (1 point)

**Answer: We don't know the status of a large portion of fungi and invertebrates so it's possible that we are underestimating the threat of extinction to these taxons** 


**Now read in the second data file, spendingdata.csv**
This dataset has a species id that matches the species id in the conservation dataset (speciesid), year, and the spending on conservation of that species (spending, in 2015 $, i.e. accounting for inflation)
```{r, message=FALSE, warning=FALSE}
spendingdata<-data.frame(read.csv("C:\\Users\\lukesau\\Desktop\\esp106-erin_rodriguez\\Midterm 1\\spendingdata.csv"))
mergeddata<-data.frame(read.csv("C:\\Users\\lukesau\\Desktop\\esp106-erin_rodriguez\\Midterm 1\\mergeddata.csv"))
```

4. Merge in the data from the conservation status data frame to the spending data frame, so that we have information on species names, taxonomic group, and conservation status with the spending data. (2 points)

```{r, message=FALSE, warning=FALSE}
df4<-merge(conservationdata, spendingdata)

```

*NOTE: If you have trouble with this step, there is a file mergeddata.csv on Canvas. You can download that and use for subsequent questions.* 

5. a) Make a plot showing the distribution of spending in the year 2016 (3 points)
```{r, message=FALSE, warning=FALSE}
require(scales)
df5<-subset(df4, Year==2016)
ggplot(df5, aes(x=speciesname, y=spending))+
  geom_histogram(stat="identity")+
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1, size=2))+
  scale_y_continuous(labels = scales::comma, limits=c(0,22000000))+
  scale_x_discrete(label = function(x) stringr::str_trunc(x, 12))
```


b) Notice the (very) long right tail on spending data - we spend a lot on a very small number of species. Identify the 3 species with the most spending in 2016. (2 points)
```{r, message=FALSE, warning=FALSE}
df5ordered<-df5[order(-df5$spending),]
for (i in 1:3){
  print(df5ordered[i, "speciesname"])
}
```

Look up these scientific names - what type of species are these?
**Answer: Chinook salmon, Rainbow Trout, Coho salmon** 

6. Finally, we will use a regression to look at the relationship between spending and species taxon.

Because the distribution of spending is very right-skewed, it would be a good idea to take the logarithm of spending before using it in a regression. 
Remember that log(0)=infinity. That means we have to drop observations with zero spending before taking the logarithm.

a) Drop the rows where spending == 0 from the data frame and then make a new column with the logarithm (log()) of spending in each year. (2 points)

*HINT: Remember you can drop rows from a dataframe using a negative index - ie. df[-c(rows to drop),]*
```{r, message=FALSE, warning=FALSE}
df6<-df4[df4$spending!=0,]
logcolumn<-c()
for (i in 1:nrow(df6)){
  logcolumn<-append(logcolumn, log(df6[i, "spending"]))
}
df6<-cbind(df6, logspending=logcolumn)
```


*Optional: Look at the distribution of the logged spending variable and see how it looks different from the plot you made in question 5a*

b) Run a regression of logged spending on taxonomic group and print the summary for the regression below (3 points)
```{r, message=FALSE, warning=FALSE}
regression6b<-lm(logspending~taxon, data=df6)
summary(regression6b)
```

c) The way to interpret these coefficients are as the fractional difference in spending between the taxonomic group (e.g. Birds, Fishes etc) and the "dropped" group, where by default the dropped group will be Amphibians. Positive numbers indicate that group has more spent on it than Amphibians and negative numbers indicate it has less spent on it. 

Based on your results in b, do we see statistically significant differences in spending between different taxonomic groups? If so, which kinds of species tend to have more spent on them and which have less? (1 points)

**Answer:** 

7. Push your R markdown file to your Github repository (2 points)
